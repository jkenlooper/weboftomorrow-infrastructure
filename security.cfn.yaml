AWSTemplateFormatVersion: "2010-09-09"

Description: >
  Set Roles and Policies for weboftomorrow stack.

Metadata:
  Author: Jake Hickenlooper

Parameters:
  ProjectSlug:
    Type: "String"
    Description: Should not change. See build-change-set.cfn.yaml
    Default: "weboftomorrow"
    AllowedValues:
      - "weboftomorrow"

Resources:

  StaticPipelineManagedPolicy:
    Type: "AWS::IAM::ManagedPolicy"
    Properties:
      Roles:
        - Fn::ImportValue:
            !Sub "root-${ProjectSlug}StaticPipelineRole"
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          -
            Effect: Allow
            Action:
              - "s3:GetObject"
              - "s3:PutObject"
            Resource:
              - !Sub
                - "${pipelinebucketarn}/*"
                -
                  pipelinebucketarn:
                    Fn::ImportValue: "root-PipelineBucketArn"
          -
            Action:
              - cloudwatch:*
            Resource: "*"
            Effect: Allow
          -
            Action:
              - codebuild:BatchGetBuilds
              - codebuild:StartBuild
              - codebuild:BatchGetBuildBatches
              - codebuild:StartBuildBatch
            Resource: "*"
            Effect: Allow
          -
            Effect: Allow
            Action:
              - "logs:CreateLogStream"
              - "logs:CreateLogGroup"
              - "logs:PutLogEvents"
            Resource:
              - !Sub "arn:aws:logs:*:${AWS::AccountId}:log-group:*:log-stream:*"
              - !Sub "arn:aws:logs:*:${AWS::AccountId}:log-group:*"
          -
            Action:
            - cloudwatch:*
            - sns:*
            Resource: "*"
            Effect: Allow
          -
            Action:
            - lambda:InvokeFunction
            - lambda:ListFunctions
            Resource: "*"
            Effect: Allow
          -
            Effect: Allow
            Action:
            - states:DescribeExecution
            - states:DescribeStateMachine
            - states:StartExecution
            Resource: "*"

  StaticPipelinePolicy:
    Type: "AWS::IAM::Policy"
    Properties:
      PolicyName: "StaticPipelinePolicy"
      Roles:
        - Fn::ImportValue:
            !Sub "root-${ProjectSlug}StaticPipelineRole"
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          -
            Effect: Allow
            Action:
              - s3:GetObject
              - s3:GetObjectVersion
            Resource:
              - !Sub
                - "${artifactbucketarn}/${ProjectSlug}/StaticBuild/*"
                -
                  artifactbucketarn:
                    Fn::ImportValue: "root-ArtifactBucketArn"
          -
            Effect: Allow
            Action:
              - s3:ListBucketVersions
              - s3:ListBucket
              - s3:GetBucketVersioning
            Resource:
              -
                Fn::ImportValue: "root-ArtifactBucketArn"
          -
            Action:
              - "s3:GetObject"
              - "s3:PutObject"
              - "s3:DeleteObject"
            Effect: "Allow"
            Resource:
              - !Sub
                - "${staticwebsitebucketarn}/${ProjectSlug}/stage/*"
                -
                  staticwebsitebucketarn:
                    Fn::ImportValue: "root-StaticWebsiteBucketArn"
              - !Sub
                - "${staticwebsitebucketarn}/${ProjectSlug}/production/*"
                -
                  staticwebsitebucketarn:
                    Fn::ImportValue: "root-StaticWebsiteBucketArn"

  S3UpdateWebsiteProductionPolicy:
    Type: "AWS::IAM::Policy"
    Properties:
      PolicyName: "S3UpdateWebsiteProductionPolicy"
      Roles:
        - Fn::ImportValue:
            !Sub "root-${ProjectSlug}S3UpdateWebsiteProductionRole"
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          -
            Effect: Allow
            Action:
              - "s3:PutObject"
              - "s3:GetObject"
              - "s3:DeleteObject"
              - "s3:ListObjectsV2"
            Resource:
              - !Sub
                - "${staticwebsitebucketarn}/${ProjectSlug}/production/*"
                -
                  staticwebsitebucketarn:
                    Fn::ImportValue: "root-StaticWebsiteBucketArn"
          -
            Effect: Allow
            Action:
              - "s3:ListBucket"
              - "s3:GetBucketLocation"
            Resource:
              -
                Fn::ImportValue: "root-StaticWebsiteBucketArn"
          -
            Effect: Allow
            Action:
              - "s3:PutObject"
            Resource:
              - !Sub
                - "${artifactbucketbucketarn}/${ProjectSlug}/StaticBuild/*"
                -
                  artifactbucketbucketarn:
                    Fn::ImportValue: "root-ArtifactBucketArn"
          -
            Effect: Allow
            Action:
              - "logs:CreateLogStream"
              - "logs:CreateLogGroup"
              - "logs:PutLogEvents"
            Resource:
              - !Sub "arn:aws:logs:*:${AWS::AccountId}:log-group:${ProjectSlug}-StaticPatch:log-stream:*"
              - !Sub "arn:aws:logs:*:${AWS::AccountId}:log-group:${ProjectSlug}-StaticPatch"
              - !Sub "arn:aws:logs:*:${AWS::AccountId}:log-group:${ProjectSlug}-SyncGreenToBlue:log-stream:*"
              - !Sub "arn:aws:logs:*:${AWS::AccountId}:log-group:${ProjectSlug}-SyncGreenToBlue"
              - !Sub "arn:aws:logs:*:${AWS::AccountId}:log-group:${ProjectSlug}-DeployGreenVersion:log-stream:*"
              - !Sub "arn:aws:logs:*:${AWS::AccountId}:log-group:${ProjectSlug}-DeployGreenVersion"

  S3CleanupLambdaWebsiteProductionPolicy:
    Type: "AWS::IAM::Policy"
    Properties:
      PolicyName: "S3CleanupLambdaWebsiteProductionPolicy"
      Roles:
        - Fn::ImportValue:
            !Sub "root-${ProjectSlug}S3UpdateWebsiteProductionRole"
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          -
            Effect: Allow
            Action:
              - "logs:CreateLogStream"
              - "logs:CreateLogGroup"
              - "logs:PutLogEvents"
            Resource:
              - !Sub "arn:aws:logs:*:${AWS::AccountId}:*"
          -
            Action:
              - "codepipeline:PutJobSuccessResult"
              - "codepipeline:PutJobFailureResult"
            Effect: "Allow"
            Resource: "*"

  StaticBuildPolicy:
    Type: "AWS::IAM::Policy"
    Properties:
      PolicyName: "StaticBuildPolicy"
      Roles:
        - Fn::ImportValue:
            !Sub "root-${ProjectSlug}StaticBuildRole"
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          -
            Effect: "Allow"
            Resource:
              - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${ProjectSlug}/*"
            Action:
              - "ssm:GetParameters"
          -
            Effect: Allow
            Action:
              - "s3:PutObject"
            Resource:
              - !Sub
                - "${artifactbucketbucketarn}/${ProjectSlug}/StaticBuild/*"
                -
                  artifactbucketbucketarn:
                    Fn::ImportValue: "root-ArtifactBucketArn"
          -
            Effect: Allow
            Action:
              - "logs:CreateLogStream"
              - "logs:CreateLogGroup"
              - "logs:PutLogEvents"
            Resource:
              - !Sub "arn:aws:logs:*:${AWS::AccountId}:log-group:${ProjectSlug}-StaticBuild:log-stream:*"
              - !Sub "arn:aws:logs:*:${AWS::AccountId}:log-group:${ProjectSlug}-StaticBuild"

  StaticTestPolicy:
    Type: "AWS::IAM::Policy"
    Properties:
      PolicyName: "StaticTestPolicy"
      Roles:
        - Fn::ImportValue:
            !Sub "root-${ProjectSlug}StaticTestRole"
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          -
            Effect: "Allow"
            Resource:
              - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${ProjectSlug}/*"
            Action:
              - "ssm:GetParameters"
          -
            Effect: Allow
            Action:
              - "logs:CreateLogStream"
              - "logs:CreateLogGroup"
              - "logs:PutLogEvents"
            Resource:
              - !Sub "arn:aws:logs:*:${AWS::AccountId}:log-group:${ProjectSlug}-StaticTest:log-stream:*"
              - !Sub "arn:aws:logs:*:${AWS::AccountId}:log-group:${ProjectSlug}-StaticTest"


